name: Deploy CMS to Netlify

on:
  push:
    branches: [ master ]
    paths: 
      - 'cms-admin/**'
      - '_products/**'
      - '_offers/**'
  workflow_dispatch:

jobs:
  deploy-cms:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Pillow
        run: python -m pip install --upgrade pip && pip install Pillow
      - name: Generate responsive image variants
        run: python generate_images.py --widths 300,600,900 --webp-quality-original 87 --webp-quality 80 --png-compress-level 6
        
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Build Jekyll site
        run: bundle exec jekyll build
        env:
          JEKYLL_ENV: production
          
      - name: Prepare CMS for Netlify
        run: |
          mkdir -p netlify-deploy
          if [ -d "_site/cms-admin" ]; then
            cp -r _site/cms-admin/* netlify-deploy/
            mkdir -p netlify-deploy/assets
            [ -d "_site/assets/css" ] && cp -r _site/assets/css netlify-deploy/assets/ || true
            [ -d "_site/assets/images" ] && cp -r _site/assets/images netlify-deploy/assets/ || true
            echo "✅ CMS admin prepared for Netlify"
            ls -la netlify-deploy/
          else
            echo "❌ No CMS admin directory found"
            exit 1
          fi
          
      - name: Deploy to Netlify
        if: env.NETLIFY_AUTH_TOKEN != '' && env.NETLIFY_SITE_ID != ''
        run: |
          npm install -g netlify-cli
          netlify deploy --prod --dir=netlify-deploy --site=${{ secrets.NETLIFY_SITE_ID }} --auth=${{ secrets.NETLIFY_AUTH_TOKEN }}
          echo "✅ CMS deployed to Netlify"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          
      - name: Deployment Status
        run: |
          if [ -z "${{ secrets.NETLIFY_AUTH_TOKEN }}" ] || [ -z "${{ secrets.NETLIFY_SITE_ID }}" ]; then
            echo "⚠️  Netlify secrets not configured"
            echo "   Add NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID to repository secrets"
            echo "   CMS files are ready in netlify-deploy/ directory"
          else
            echo "✅ Netlify CMS deployment complete"
          fi